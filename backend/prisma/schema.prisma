generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id       String @id @default(uuid()) @db.VarChar(36)
  email    String @unique @db.VarChar(255)
  password String @db.VarChar(60)
  fullName String @map("full_name") @db.VarChar(255)
  // role     Role
  // hệ hệ nhiều nhiều với roles

  candidateId String?  @unique @map("candidate_id") @db.VarChar(36)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  candidate   Candidate?   @relation("UserToCandidate", fields: [candidateId], references: [id])
  mentorships Mentorship[] @relation("MentorToMentorship")
  submissions Submission[]
  judgeRooms  JudgeRoom[]
  givenScores BaremScore[] @relation("MentorToScore")
  userRoles   UserRole[]
  noteJudges  NoteJudge[]

  @@map("users")
}

model Candidate {
  id          String           @id @default(uuid()) @db.VarChar(36)
  studentCode String           @unique @map("student_code") @db.VarChar(10)
  phone       String           @db.VarChar(12)
  major       String           @db.VarChar(50)
  semester    String           @db.VarChar(255)
  teamId      String?          @map("team_id") @db.VarChar(36)
  mentorNote  String?          @map("mentor_note") @db.Text
  statusC3    StatusChallenge3 @default(WAITING) @map("status_c3")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  user        User?        @relation("UserToCandidate")
  team        Team?        @relation("CandidateToTeam", fields: [teamId], references: [id], onDelete: SetNull)
  ledTeam     Team?        @relation("TeamLeader")
  baremScores BaremScore[] @relation("CandidateReceivedScore")
  resume      Resume?
  interview   Interview?

  @@map("candidates")
}

model Team {
  id           String  @id @default(uuid()) @db.VarChar(36)
  group        Int     @unique @db.Int
  name         String? @unique @db.VarChar(255)
  mentorshipId String  @map("mentorship_id") @db.VarChar(36)
  leaderId     String? @unique @map("leader_id") @db.VarChar(36)
  topicId      String  @map("topic_id") @db.VarChar(36)
  mentorNote   String? @map("mentor_note") @db.Text
  reportLink   String? @map("report_link") @db.Text

  mentorship      Mentorship       @relation("MentorshipToTeam", fields: [mentorshipId], references: [id])
  leader          Candidate?       @relation("TeamLeader", fields: [leaderId], references: [id])
  topic           Topic            @relation(fields: [topicId], references: [id])
  candidates      Candidate[]      @relation("CandidateToTeam")
  submissions     Submission[]
  schedulePresent SchedulePresent?
  rooms           Room[]
  noteJudges      NoteJudge[]

  @@map("teams")
}

model Mentorship {
  id       String @id @default(uuid()) @db.VarChar(36)
  mentorId String @map("mentor_id") @db.VarChar(36)
  facebook String @db.VarChar(255)
  discord  String @db.VarChar(255)
  phone    String @db.VarChar(12)

  mentor User   @relation("MentorToMentorship", fields: [mentorId], references: [id])
  teams  Team[] @relation("MentorshipToTeam")

  @@map("mentorship")
}

model Topic {
  id        String   @id @default(uuid()) @db.VarChar(36)
  title     String   @db.VarChar(255)
  filePath  String   @map("file_path") @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  teams Team[]

  @@map("topics")
}

model Submission {
  id                 String   @id @default(uuid()) @db.VarChar(36)
  teamId             String   @map("team_id") @db.VarChar(36)
  userId             String   @map("user_id") @db.VarChar(36)
  slideLink          String   @map("slide_link") @db.VarChar(255)
  taskAssignmentLink String   @map("task_assignment_link") @db.VarChar(255)
  productLinks       Json     @map("product_links") @db.Json
  note               String?  @db.Text
  submittedAt        DateTime @map("submitted_at")

  team Team @relation(fields: [teamId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@map("submissions")
}

model Room {
  id           String            @id @default(uuid()) @db.VarChar(36)
  presentPhase PresentationPhase @default(TRIAL) @map("present_phase")
  modePresent  ModePresentation  @default(OFFLINE) @map("mode_present")
  roomNumber   String            @map("room_number") @db.VarChar(255)
  startTime    DateTime          @default(now()) @map("start_time")
  endTime      DateTime          @default(now()) @map("end_time")

  teamId     String?     @map("team_id") @db.VarChar(36)
  judgeRooms JudgeRoom[]
  team       Team?       @relation(fields: [teamId], references: [id])

  @@map("rooms")
}

model Roles {
  id        Int        @id @default(autoincrement()) @db.Int
  role      Role
  userRoles UserRole[]

  @@map("roles")
}

// model roles: 1 người dùng có nhiều roles
model UserRole {
  userId     String   @map("user_id") @db.VarChar(36)
  roleId     Int      @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Roles @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model NoteJudge {
  id      String @id @default(uuid()) @db.VarChar(36)
  judgeId String @map("judge_id") @db.VarChar(36)
  teamId  String @map("team_id") @db.VarChar(36)
  note    String @db.Text

  judge User @relation(fields: [judgeId], references: [id], onDelete: Cascade)
  team  Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([judgeId, teamId])
  @@map("note_judges")
}

model JudgeRoom {
  id      String @id @default(uuid()) @db.VarChar(36)
  judgeId String @map("judge_id") @db.VarChar(36)
  roomId  String @map("room_id") @db.VarChar(36)

  judge User @relation(fields: [judgeId], references: [id])
  room  Room @relation(fields: [roomId], references: [id])

  @@map("judge_rooms")
}

model Notification {
  id        String   @id @default(uuid()) @db.VarChar(36)
  title     String   @db.VarChar(255)
  message   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notifications")
}

model BaremScore {
  id          String         @id @default(uuid()) @db.VarChar(36)
  role        RoleBarem      @default(MENTOR)
  type        TypeEvaluation @default(PROCESSING)
  codeBarem   String         @map("code_barem") @db.VarChar(255)
  mentorId    String         @map("mentor_id") @db.VarChar(36)
  candidateId String         @map("candidate_id") @db.VarChar(36)
  score       Float
  note        String?        @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  mentor    User      @relation("MentorToScore", fields: [mentorId], references: [id])
  candidate Candidate @relation("CandidateReceivedScore", fields: [candidateId], references: [id])

  @@unique([mentorId, codeBarem, candidateId])
  @@index([candidateId])
  @@index([mentorId])
  @@index([type])
  @@index([codeBarem])
  @@map("scores")
}

model SchedulePresent {
  id     String @id @default(uuid()) @db.VarChar(36)
  teamId String @unique @map("team_id") @db.VarChar(36)

  trialDate      String  @map("trial_date") @db.VarChar(255)
  officialDate   Json    @map("offical_date") @db.Json
  finalDate      String? @map("final_date") @db.VarChar(255)
  googleMeetLink String? @map("google_meet_link") @db.VarChar(255)
  videoRecord    String? @map("video_record") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  team Team @relation(fields: [teamId], references: [id])

  @@map("schedule_presents")
}

model Resume {
  id          String    @id @default(uuid()) @db.VarChar(36)
  candidateId String    @unique @map("candidate_id") @db.VarChar(36)
  filePath    String    @map("file_path") @db.VarChar(255)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  candidate   Candidate @relation(fields: [candidateId], references: [id])

  @@map("resumes")
}

model Interview {
  id          String    @id @default(uuid()) @db.VarChar(36)
  candidateId String    @unique @map("candidate_id") @db.VarChar(36)
  filePath    String    @map("file_path") @db.VarChar(255)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  candidate   Candidate @relation(fields: [candidateId], references: [id])

  @@map("interviews")
}

enum Role {
  CANDIDATE
  HOST
  MENTOR
  JUDGE
  ADMIN
}

enum RoleBarem {
  MENTOR
  JUDGE
}

enum TypeEvaluation {
  PROCESSING
  TRIAL_PRESENTATION
  OFFICIAL_PRESENTATION
}

// OFFLINE, ONLINE
enum ModePresentation {
  OFFLINE
  ONLINE
}

enum PresentationPhase {
  TRIAL
  OFFICIAL
}

enum StatusChallenge3 {
  WAITING
  FAILED
  PASSED
  REDO
}
